<!DOCTYPE html>
<html lang="pt-BR">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Não Conformidades - Sistema de Auditoria</title>
      <link rel="stylesheet" href="../static/css/NCs.css">
      <style>
        #checklistDiv {
          display: none;
          margin-top: 20px;
        }

        #NCsButton {
          border-bottom: 4px solid #2657caff;
          color: #2657caff;
        }

        #NCsButton img {
          filter: brightness(0) saturate(100%) invert(34%) sepia(83%) saturate(749%)
            hue-rotate(203deg) brightness(91%) contrast(101%);
        }
      </style>
  </head>
  <body>

    {% include 'components/header.html' %}

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <script>
            {% for category, message in messages %}
                alert("{{ message }}");
            {% endfor %}
            </script>
        {% endif %}
    {% endwith %}


    <div class="container">
        <!-- Header -->
        <div class="header">
            <h2 class="title">Não Conformidades</h2>
            <div class="header-actions">
                <div class="escalated-legend">
                    <div class="escalated-dot"></div>
                    <span>Escalonadas</span>
                </div>
                <button class="btn btn-primary">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
                        <path d="M12 9v4"/>
                        <path d="m12 17 .01 0"/>
                    </svg>
                    Nova Auditoria
                </button>
            </div>
        </div>

        <!-- Filters Card -->
        <div class="card filters-card">
            <div class="filters-container">
                <div class="search-container">
                    <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    <input type="text" placeholder="Buscar não conformidades..." class="search-input">
                </div>
                <select class="status-filter">
                    <option value="todas">Todas</option>
                    <option value="Aberta">Aberta</option>
                    <option value="Em Andamento">Em Andamento</option>
                    <option value="Resolvida">Resolvida</option>
                </select>
            </div>
        </div>

        <!-- Non-Conformities List -->
        <div class="nc-list">
        {% for nc in NCs %}
            {% set ncInfo = nc_dict.get(nc.id) %}
            <div class="nc-item">
                <div class="nc-content">
                    <div class="nc-header">
                        <span class="nc-id">NC-{{ nc.pergunta_id }}</span>
                        {% set classificacao = ncInfo.classificacao if ncInfo else 'leve' %}
                        <span class="badge badge-{{ classificacao|lower }}">{{ classificacao|capitalize }}</span>
                        <span>
                        {{ nc.pergunta.descricao }}
                        </span>
                    </div>
                    
                    <p class="nc-description">{{ nc.observacoes or "Sem observações" }}</p>
                    
                    <div class="nc-metadata">
                        <div class="metadata-item">
                            <span>Auditoria: {{ nc.auditoria_checklist.nome }}</span>
                        </div>
                        <div class="metadata-item">
                            <span>Auditor: {{ nc.auditoria_checklist.auditor.nome }}</span>
                        </div>
                        <div class="metadata-item">
                            <span>{{ nc.auditoria_checklist.data_auditoria.strftime("%d/%m/%Y") }}</span>
                        </div>
                    </div>
                </div>

                <div class="nc-actions">
                    <select class="status-select">
                        <option value="Aberta" {% if ncInfo and ncInfo.situacao == "em_aberto" %}selected{% endif %}>Aberta</option>
                        <option value="Em Andamento" {% if ncInfo and ncInfo.situacao == "em_andamento" %}selected{% endif %}>Em Andamento</option>
                        <option value="Resolvida" {% if ncInfo and ncInfo.situacao == "encerrada" %}selected{% endif %}>Resolvida</option>
                    </select>

                    <!-- Botão de envio manual de email -->
                    <form action="{{ url_for('enviar_email_nc_manual', nc_id=ncInfo.id) }}" method="post" style="display:inline;">
                        <button type="submit" class="btn btn-success">Enviar Email</button>
                    </form>
                </div>
            </div>
        {% else %}
            <p>Nenhuma não conformidade encontrada.</p>
        {% endfor %}

        </div>
    </div>
  </body>
</html>
